<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manajemen Peminjaman | Admin</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            emerald: {
              50: '#ecfdf5',
              100: '#d1fae5',
              200: '#a7f3d0',
              300: '#6ee7b7',
              400: '#34d399',
              500: '#10b981',
              600: '#059669',
              700: '#047857',
              800: '#065f46',
              900: '#064e3b',
            }
          }
        }
      }
    }
  </script>

  <!-- AOS Animation -->
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

  <!-- Boxicons -->
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-emerald-700">Manajemen Peminjaman</h1>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Filter & Stats -->
    <div class="mb-6 flex flex-col sm:flex-row gap-4" data-aos="fade-up">
      <div class="flex-1">
        <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
          <option value="">Semua Status</option>
          <option value="Menunggu">Menunggu Persetujuan</option>
          <option value="Disetujui">Disetujui</option>
          <option value="Dikembalikan">Dikembalikan</option>
          <option value="Ditolak">Ditolak</option>
        </select>
      </div>
      <div class="flex gap-3 flex-wrap">
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg px-4 py-2 flex items-center gap-2 text-yellow-800">
          <i class='bx bx-time'></i>
          <span class="font-medium">Menunggu: <span id="countPending">0</span></span>
        </div>
        <div class="bg-emerald-50 border border-emerald-200 rounded-lg px-4 py-2 flex items-center gap-2 text-emerald-800">
          <i class='bx bx-check-circle'></i>
          <span class="font-medium">Disetujui: <span id="countApproved">0</span></span>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg px-4 py-2 flex items-center gap-2 text-blue-800">
          <i class='bx bx-undo'></i>
          <span class="font-medium">Dikembalikan: <span id="countReturned">0</span></span>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden" data-aos="fade-up" data-aos-delay="100">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-emerald-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-emerald-800 uppercase tracking-wider">Anggota</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-emerald-800 uppercase tracking-wider">Buku</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-emerald-800 uppercase tracking-wider hidden sm:table-cell">Tgl Pinjam</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-emerald-800 uppercase tracking-wider hidden md:table-cell">Tgl Kembali</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-emerald-800 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-emerald-800 uppercase tracking-wider">Aksi</th>
            </tr>
          </thead>
          <tbody id="loansTableBody" class="bg-white divide-y divide-gray-200">
            <!-- Data akan diisi via JS -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Modal Detail Peminjaman -->
  <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-screen overflow-y-auto transform transition-all" data-aos="zoom-in" data-aos-duration="300">
      <div class="flex justify-between items-center p-6 border-b border-gray-200 sticky top-0 bg-white">
        <h3 class="text-xl font-semibold text-emerald-800">Detail Peminjaman</h3>
        <button id="closeDetailModal" class="text-gray-400 hover:text-gray-600">
          <i class='bx bx-x text-2xl'></i>
        </button>
      </div>
      <div class="p-6 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <p class="text-sm text-gray-600">Anggota</p>
            <p id="detailMember" class="font-medium text-gray-900">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Jumlah Buku</p>
            <p id="detailBookCount" class="font-medium text-gray-900">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Tanggal Pinjam</p>
            <p id="detailBorrowDate" class="font-medium text-gray-900">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-600">Tanggal Kembali</p>
            <p id="detailReturnDate" class="font-medium text-gray-900">-</p>
          </div>
          <div class="md:col-span-2">
            <p class="text-sm text-gray-600">Status</p>
            <p id="detailStatusBadge" class="font-medium">
              <span class="px-2 py-1 text-xs rounded-full" id="statusBadgeDetail">-</span>
            </p>
          </div>
        </div>

        <div>
          <h4 class="font-semibold text-emerald-800 mb-3 flex items-center gap-2">
            <i class='bx bx-book'></i>
            Daftar Buku yang Dipinjam
          </h4>
          <div id="bookList" class="space-y-2">
            <!-- Daftar buku akan diisi via JS -->
          </div>
        </div>

        <!-- Tombol Aksi di Modal (hanya jika status Menunggu atau Disetujui) -->
        <div id="actionButtons" class="hidden flex justify-end gap-3 pt-4 border-t">
          <button id="approveBtn" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md font-medium flex items-center gap-2">
            <i class='bx bx-check'></i> Setujui
          </button>
          <button id="returnBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium flex items-center gap-2">
            <i class='bx bx-undo'></i> Kembalikan
          </button>
          <button id="rejectBtn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md font-medium flex items-center gap-2">
            <i class='bx bx-x'></i> Tolak
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script>
    AOS.init({ once: true });

    // Dummy data peminjaman
    let loans = [
      {
        id: 1,
        member: "Ahmad Fauzi",
        memberId: 1,
        books: ["Dasar-Dasar Pemrograman Web", "HTML & CSS untuk Pemula"],
        borrowDate: "2025-10-20",
        returnDate: "2025-11-20",
        status: "Menunggu"
      },
      {
        id: 2,
        member: "Siti Nurhaliza",
        memberId: 2,
        books: ["Manajemen Proyek IT"],
        borrowDate: "2025-10-28",
        returnDate: "2025-11-28",
        status: "Disetujui"
      },
      {
        id: 3,
        member: "Budi Santoso",
        memberId: 3,
        books: ["Algoritma dan Struktur Data", "Python untuk Data Science"],
        borrowDate: "2025-10-15",
        returnDate: "2025-11-15",
        status: "Dikembalikan"
      },
      {
        id: 4,
        member: "Ahmad Fauzi",
        memberId: 1,
        books: ["JavaScript Lanjutan"],
        borrowDate: "2025-11-01",
        returnDate: "2025-12-01",
        status: "Ditolak"
      }
    ];

    const tableBody = document.getElementById('loansTableBody');
    const statusFilter = document.getElementById('statusFilter');
    const countPending = document.getElementById('countPending');
    const countApproved = document.getElementById('countApproved');
    const countReturned = document.getElementById('countReturned');
    const detailModal = document.getElementById('detailModal');
    const closeDetailModal = document.getElementById('closeDetailModal');
    let currentLoanId = null;

    // Render tabel
    function renderTable(data = loans) {
      tableBody.innerHTML = '';
      let pending = 0, approved = 0, returned = 0;

      data.forEach(loan => {
        if (loan.status === 'Menunggu') pending++;
        if (loan.status === 'Disetujui') approved++;
        if (loan.status === 'Dikembalikan') returned++;

        const statusColor = {
          'Menunggu': 'bg-yellow-100 text-yellow-800',
          'Disetujui': 'bg-emerald-100 text-emerald-800',
          'Dikembalikan': 'bg-blue-100 text-blue-800',
          'Ditolak': 'bg-red-100 text-red-800'
        };

        const row = `
          <tr class="hover:bg-gray-50 transition">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${loan.member}</td>
            <td class="px-6 py-4 text-sm text-gray-600">
              <div class="max-w-xs truncate">${loan.books.join(', ')}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 hidden sm:table-cell">${loan.borrowDate}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 hidden md:table-cell">${loan.returnDate}</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 text-xs rounded-full font-medium ${statusColor[loan.status]}">
                ${loan.status}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <button onclick="openDetail(${loan.id})" class="text-emerald-600 hover:text-emerald-800 mr-2">
                <i class='bx bx-detail'></i>
              </button>
              ${loan.status === 'Menunggu' ? `
                <button onclick="updateStatus(${loan.id}, 'Disetujui')" class="text-emerald-600 hover:text-emerald-800 mr-2">
                  <i class='bx bx-check'></i>
                </button>
                <button onclick="updateStatus(${loan.id}, 'Ditolak')" class="text-red-600 hover:text-red-800">
                  <i class='bx bx-x'></i>
                </button>
              ` : ''}
              ${loan.status === 'Disetujui' ? `
                <button onclick="updateStatus(${loan.id}, 'Dikembalikan')" class="text-blue-600 hover:text-blue-800">
                  <i class='bx bx-undo'></i>
                </button>
              ` : ''}
            </td>
          </tr>`;
        tableBody.innerHTML += row;
      });

      countPending.textContent = pending;
      countApproved.textContent = approved;
      countReturned.textContent = returned;
    }

    // Filter status
    statusFilter.addEventListener('change', () => {
      const filter = statusFilter.value;
      const filtered = filter ? loans.filter(l => l.status === filter) : loans;
      renderTable(filtered);
    });

    // Buka detail
    window.openDetail = (id) => {
      const loan = loans.find(l => l.id === id);
      currentLoanId = id;

      document.getElementById('detailMember').textContent = loan.member;
      document.getElementById('detailBookCount').textContent = loan.books.length + ' buku';
      document.getElementById('detailBorrowDate').textContent = loan.borrowDate;
      document.getElementById('detailReturnDate').textContent = loan.returnDate;

      const statusBadge = document.getElementById('statusBadgeDetail');
      const colorMap = {
        'Menunggu': 'bg-yellow-100 text-yellow-800',
        'Disetujui': 'bg-emerald-100 text-emerald-800',
        'Dikembalikan': 'bg-blue-100 text-blue-800',
        'Ditolak': 'bg-red-100 text-red-800'
      };
      statusBadge.className = `px-2 py-1 text-xs rounded-full font-medium ${colorMap[loan.status]}`;
      statusBadge.textContent = loan.status;

      const bookList = document.getElementById('bookList');
      bookList.innerHTML = '';
      loan.books.forEach(book => {
        bookList.innerHTML += `
          <div class="flex items-center gap-2 p-2 bg-gray-50 rounded border">
            <i class='bx bx-book text-emerald-600'></i>
            <span class="text-sm font-medium text-gray-800">${book}</span>
          </div>`;
      });

      const actionButtons = document.getElementById('actionButtons');
      if (loan.status === 'Menunggu' || loan.status === 'Disetujui') {
        actionButtons.classList.remove('hidden');
        document.getElementById('approveBtn').style.display = loan.status === 'Menunggu' ? 'flex' : 'none';
        document.getElementById('returnBtn').style.display = loan.status === 'Disetujui' ? 'flex' : 'none';
        document.getElementById('rejectBtn').style.display = loan.status === 'Menunggu' ? 'flex' : 'none';
      } else {
        actionButtons.classList.add('hidden');
        document.getElementById('approveBtn').style.display = 'none';
        document.getElementById('returnBtn').style.display = 'none';
        document.getElementById('rejectBtn').style.display = 'none';
      }

      detailModal.classList.remove('hidden');
    };

    // Update status via tombol di tabel atau modal
    window.updateStatus = (id, newStatus) => {
      Swal.fire({
        title: `Apakah Anda yakin ingin mengubah status menjadi "${newStatus}"?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Ya, ubah!',
        cancelButtonText: 'Batal'
      }).then((result) => {
        if (result.isConfirmed) {
          const loan = loans.find(l => l.id === id);
          loan.status = newStatus;
          renderTable(loans.filter(l => !statusFilter.value || l.status === statusFilter.value));
          if (detailModal.classList.contains('hidden') === false && currentLoanId === id) {
            openDetail(id); // Refresh modal
          }
          Swal.fire('Berhasil!', `Status peminjaman diubah menjadi "${newStatus}".`, 'success');
        }
      });
    };

    // Tombol aksi di modal
    document.getElementById('approveBtn').addEventListener('click', () => updateStatus(currentLoanId, 'Disetujui'));
    document.getElementById('returnBtn').addEventListener('click', () => updateStatus(currentLoanId, 'Dikembalikan'));
    document.getElementById('rejectBtn').addEventListener('click', () => updateStatus(currentLoanId, 'Ditolak'));

    // Tutup modal
    closeDetailModal.addEventListener('click', () => detailModal.classList.add('hidden'));
    detailModal.addEventListener('click', (e) => {
      if (e.target === detailModal) detailModal.classList.add('hidden');
    });

    // Inisialisasi
    renderTable();
  </script>
</body>
</html>
